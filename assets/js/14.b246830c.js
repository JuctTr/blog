(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{422:function(t,e,n){"use strict";n.r(e);var a=n(2),s=Object(a.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"usecontext重渲染问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#usecontext重渲染问题"}},[t._v("#")]),t._v(" useContext重渲染问题")]),t._v(" "),e("blockquote",[e("p",[t._v("注：本文不会介绍useContext和useReducer怎么使用，如读者对这两个的使用还有疑惑，可以移步"),e("a",{attrs:{href:"https://zh-hans.reactjs.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("React官网"),e("OutboundLink")],1),t._v("，以下更多的是从实践中得到的经验")])]),t._v(" "),e("h2",{attrs:{id:"基本概念"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#基本概念"}},[t._v("#")]),t._v(" 基本概念")]),t._v(" "),e("p",[t._v("官方中文文档：")]),t._v(" "),e("p",[t._v("https://zh-hans.reactjs.org/docs/context.html")]),t._v(" "),e("p",[t._v("https://zh-hans.reactjs.org/docs/hooks-reference.html#usecontext")]),t._v(" "),e("p",[t._v("context的出现就是为了处理多层级组件之间更容易通信的问题，避免数据通过props属性一直在组件间自上而下（由父及子）进行传递出现的繁琐场景， 如果你遇到一下场景，那么就适合使用useContext结合useReducer来处理：")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("数据较多，复杂，页面展示依赖状态改变")]),t._v(" "),e("p",[t._v("举例：")]),t._v(" "),e("p",[t._v("假如你有一组数据，在用户访问当前页面的期间有可能被实时改变，而页面有较多地方，都要去获取它实时改变状态，那么我们不可能每一层组件以props的方式一个一个自上而下的去传递，这个时候就适合使用context")])]),t._v(" "),e("li",[e("p",[t._v("组件层级较深")]),t._v(" "),e("p",[t._v("举例：")]),t._v(" "),e("p",[t._v("有一个token参数，需要在页面中，每一处跳转的时候，携带，而跳转的地方分布在各个组件")])])]),t._v(" "),e("h2",{attrs:{id:"项目初期"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#项目初期"}},[t._v("#")]),t._v(" 项目初期")]),t._v(" "),e("p",[t._v("我之前使用过Vue，所以对于页面共享数据，习惯的思维就是，这个数据是整一个页面共享的，也就是全局数据，于是我们写这样的例子")]),t._v(" "),e("h3",{attrs:{id:"context-ts"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#context-ts"}},[t._v("#")]),t._v(" context.ts")]),t._v(" "),e("div",{staticClass:"language-javascript extra-class"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" createContext"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" useContext "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'react'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 全局数据")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("globalStore")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  \ti "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    token "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    loading "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    canvasConfig "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    showQuestionLayer "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    showRule "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    posterPopup "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("show")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("imgUrl")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    userInfoData "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("isShowLayer")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    isError "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" globalContext "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createContext")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("useGlobalContext")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("useContext")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("globalContext"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" globalContext"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" globalStore"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" useGlobalContext "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),e("h3",{attrs:{id:"reducer-ts"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#reducer-ts"}},[t._v("#")]),t._v(" reducer.ts")]),t._v(" "),e("p",[t._v("组件中一旦dispatch，就会引起state更新（引用地址变化），进而触发 "),e("code",[t._v("globalContext.Provider")]),t._v("组件上value的更新，组件树重新渲染")]),t._v(" "),e("div",{staticClass:"language-javascript extra-class"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n * 全局的 Reducer\n */")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("pageReducer")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[e("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("state")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("action")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" payload"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("action"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__setStore'")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n            state "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Object"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("assign")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" action"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("payload"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n            console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'reducer error'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" action"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("state "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),t._v(" pageReducer"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),e("h3",{attrs:{id:"index-ts"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#index-ts"}},[t._v("#")]),t._v(" index.ts")]),t._v(" "),e("p",[t._v("这里我们就利用"),e("code",[t._v("useContext")]),t._v("和"),e("code",[t._v("useReducer")]),t._v("初步实现了一个不同层级组件间，共用一份数据的方案")]),t._v(" "),e("p",[t._v("其中"),e("code",[t._v("ReadComponent")]),t._v("为获取全局数据的组件，"),e("code",[t._v("WriteComponent")]),t._v("为做dispatch操作的组件，而"),e("code",[t._v("Nothing")]),t._v("组件什么都不做，是普通组件")]),t._v(" "),e("div",{staticClass:"language-react extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("import React, { useReducer } from 'react';\nimport ReactDOM from 'react-dom/client';\nimport { Nothing, ReadComponent, WriteComponent} from './components/index';\nimport { globalStore, globalContext } from './context';\nimport pageReducer from './reducer';\nimport './index.scss';\n\nfunction Index(): React.ReactElement {\n    const [state, dispatch] = useReducer(pageReducer, new globalStore());\n\n    return (\n        <globalContext.Provider value={{ state, dispatch }}>\n            <div className=\"page\">Hello context1</div>\n            <Nothing />\n            <ReadComponent />\n            <WriteComponent />\n        </globalContext.Provider>\n    );\n}\n\nconst root = ReactDOM.createRoot(document.getElementById('root'));\nroot.render(<Index />);\n\n")])])]),e("p",[t._v("注意到以下三个组件都有日志打印")]),t._v(" "),e("div",{staticClass:"language-react extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("// ReadComponent\nimport { useGlobalContext } from '../../context';\nimport { log } from '@common/utils';\nimport React from 'react';\n\nexport default function ReadComponent() {\n    log.info('ReadComponent', 're-render');\n    const state = useGlobalContext();\n    return <div>读取Context的值：{state && state.i}</div>;\n}\n\n// WriteComponent\nimport React from 'react';\nimport { useGlobalContext } from '../../context';\nimport { log } from '@common/utils';\n\nlet j = 0;\n\nexport default function WriteComponent() {\n    log.info('WriteComponent', 're-render');\n\n    const { dispatch } = useGlobalContext();\n    const changeContext = () => {\n        dispatch({\n            type: '__setStore',\n            payload: {\n                i: ++j,\n            },\n        });\n        console.log('j => ', j);\n    };\n\n    return (\n        <div>\n            改变Context的值：\n            <a className=\"App-link\" onClick={changeContext}>\n                点击改变\n            </a>\n        </div>\n    );\n}\n\n// Nothing\nimport React from 'react';\nimport { log } from '@common/utils';\n\nexport default function Nothing() {\n    log.info('Nothing', 're-render');\n    return <div>Nothing</div>;\n}\n\n")])])]),e("p",[t._v("一切似乎都可以正常工作，开发组件也没有问题，所以我们不断的往"),e("code",[t._v("globalContext.Provider")]),t._v("里面加组件，这个时候你肯定会想，为啥要往"),e("code",[t._v("globalContext.Provider")]),t._v("加组件？不是一般用到全局数据的组件才往里面加吗？不然每一次value的值更新，就会导致里面所有的组件重新渲染，如下图所示")]),t._v(" "),e("p",[e("img",{attrs:{src:"/Users/wangyicong/Desktop/blog/docs/.vuepress/assets/img/Snipaste_2022-08-04_14-04-42.png",alt:"Snipaste_2022-08-04_14-04-42"}})]),t._v(" "),e("p",[t._v("我们点击改变，组件"),e("code",[t._v("Nothing")]),t._v("并没有去读取"),e("code",[t._v("globalContext.Provider")]),t._v("提供的value，也同样重新渲染了，这意味着，只要value变化，Provider里面的子组件都会重新渲染")]),t._v(" "),e("p",[t._v("官网提到：")]),t._v(" "),e("blockquote",[e("p",[t._v("当组件上层最近的 "),e("code",[t._v("<MyContext.Provider>")]),t._v(" 更新时，该 Hook 会触发重渲染，并使用最新传递给 "),e("code",[t._v("MyContext")]),t._v(" provider 的 context "),e("code",[t._v("value")]),t._v(" 值。即使祖先使用 "),e("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/react-api.html#reactmemo",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("React.memo")]),e("OutboundLink")],1),t._v(" 或 "),e("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/react-component.html#shouldcomponentupdate",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("shouldComponentUpdate")]),e("OutboundLink")],1),t._v("，也会在组件本身使用 "),e("code",[t._v("useContext")]),t._v(" 时重新渲染。")])]),t._v(" "),e("p",[t._v("确实是这样，但是有没有思考一个问题，我的页面布局依赖组件的编排，要是把无需全局state数据的组件移到Provider外面，就会影响页面编排，即以下图片所示问题，这个时候我还要考虑，"),e("code",[t._v("怎么去拆分不会更改和读取到全局state数据的组件？")])]),t._v(" "),e("p",[e("img",{attrs:{src:"/Users/wangyicong/Desktop/blog/docs/.vuepress/assets/img/cabe7816c20649818996136424c0ec75_tplv-k3u1fbpfcp-zoom-1.webp",alt:"cabe7816c20649818996136424c0ec75_tplv-k3u1fbpfcp-zoom-1"}})]),t._v(" "),e("h2",{attrs:{id:"使用react-memo来优化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用react-memo来优化"}},[t._v("#")]),t._v(" 使用"),e("code",[t._v("React.memo")]),t._v("来优化")]),t._v(" "),e("h3",{attrs:{id:"无副作用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#无副作用"}},[t._v("#")]),t._v(" 无副作用")]),t._v(" "),e("p",[t._v("明白memo的作用后，我们使用memo来优化组件渲染问题，我们新增一个"),e("code",[t._v("NothingMemo")]),t._v("组件，如下：")]),t._v(" "),e("div",{staticClass:"language-react extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("import React from 'react';\nimport { log } from '@common/utils';\n\nfunction NothingMemo() {\n    log.info('NothingMemo', 're-render');\n\n    return <div>NothingMemo</div>;\n}\n\nexport default React.memo(NothingMemo);\n")])])]),e("p",[t._v("点击改变，看控制台")]),t._v(" "),e("p",[e("img",{attrs:{src:"/Users/wangyicong/Desktop/blog/docs/.vuepress/assets/img/Snipaste_2022-08-04_15-24-20.png",alt:"Snipaste_2022-08-04_15-24-20"}})]),t._v(" "),e("p",[t._v("我们可以看到，在点击改变按钮时，"),e("code",[t._v("NothingMemo")]),t._v("组件就不会重新渲染了")]),t._v(" "),e("h3",{attrs:{id:"写入操作"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#写入操作"}},[t._v("#")]),t._v(" 写入操作")]),t._v(" "),e("p",[t._v("那假如我们"),e("code",[t._v("NothingMemo")]),t._v("组件会dispatch去改变全局数据呢？如下：")]),t._v(" "),e("div",{staticClass:"language-react extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("import React from 'react';\nimport { log } from '@common/utils';\n+ import { useGlobalContext } from '../../context';\n\nfunction NothingMemo() {\n    log.info('NothingMemo', 're-render');\n+    const { dispatch } = useGlobalContext();\n\n    return <div>NothingMemo</div>;\n}\n\nexport default React.memo(NothingMemo);\n\n")])])]),e("p",[t._v("依然会重新渲染，因为dispatch函数是塞在 Provider上的value中，value引用地址改变，当然会重新渲染组件，这是肯定的")]),t._v(" "),e("p",[e("img",{attrs:{src:"/Users/wangyicong/Desktop/blog/docs/.vuepress/assets/img/Snipaste_2022-08-04_15-29-00.png",alt:"Snipaste_2022-08-04_15-29-00"}})]),t._v(" "),e("h3",{attrs:{id:"比较回调"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#比较回调"}},[t._v("#")]),t._v(" 比较回调")]),t._v(" "),e("p",[t._v("那么我们这时候想着，如果我们给memo加上一个比较函数，也就是memo的第二次参数")]),t._v(" "),e("div",{staticClass:"language-react extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("import React from 'react';\nimport { log } from '@common/utils';\nimport { useGlobalContext } from '../../context';\n\nfunction NothingMemo(props) {\n    log.info('NothingMemo', 're-render');\n+    const { skuId } = props;\n    const { dispatch } = useGlobalContext();\n\n+    return <div>NothingMemo skuId: {skuId}</div>;\n}\n\n+ export default React.memo(NothingMemo, (preProps, nextProps) => {\n+     if (preProps.skuId != nextProps.skuId) {\n+         return false;\n+     }\n+    return true;\n});\n  \n // 首页代码（截取一部分）\n  function Index(): React.ReactElement {\n    const [state, dispatch] = useReducer(pageReducer, new globalStore());\n\n    return (\n        <globalContext.Provider value={{ state, dispatch }}>\n            <div className=\"page\">Hello context1</div>\n            <Nothing />\n +           <NothingMemo skuId=\"12345678\" />\n            <ReadComponent />\n            <WriteComponent />\n        </globalContext.Provider>\n    );\n}\n\nconst root = ReactDOM.createRoot(document.getElementById('root'));\nroot.render(<Index />);\n\n")])])]),e("p",[t._v("我们增加了memo的比较函数，函数中代码的意思也就是当props中的skuId变化了，我们才重新渲染组件，我们来看实际效果，如下：")]),t._v(" "),e("p",[e("img",{attrs:{src:"/Users/wangyicong/Desktop/blog/docs/.vuepress/assets/img/Snipaste_2022-08-04_15-40-55.png",alt:"Snipaste_2022-08-04_15-40-55"}})]),t._v(" "),e("p",[t._v("注意，我们并没有去改变skuId，但是实际效果，依然重新渲染了，所以这种优化不严谨")]),t._v(" "),e("h2",{attrs:{id:"使用usememo来优化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用usememo来优化"}},[t._v("#")]),t._v(" 使用useMemo来优化")]),t._v(" "),e("p",[t._v("这里在Provider新增了"),e("code",[t._v("NothingUseMemo")]),t._v("子组件，同样以上面的方式验证，这里贴出代码，具体就不验证了，这里没什么特殊的，也就是和useMemo的用法一样，useMemo内部会根据依赖项的变化而变化，而useMemo外部则不可避免的会重新渲染")]),t._v(" "),e("div",{staticClass:"language-react extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("function NothingUseMemo(props: { skuId: any }) {\n    log.info('NothingUseMemo', 're-render');\n+    const { skuId } = props;\n\n+    return React.useMemo(() => {\n+  \t\t\tlog.info('NothingUseMemo', 'useMemo re-render');\n        return <div>NothingUseMemo {skuId}</div>;\n+    }, [skuId]);\n}\n\nexport default NothingUseMemo;\n")])])]),e("h2",{attrs:{id:"总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),e("h2",{attrs:{id:"react-memo"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#react-memo"}},[t._v("#")]),t._v(" React.memo")]),t._v(" "),e("p",[t._v("官方文档：https://zh-hans.reactjs.org/docs/react-api.html#reactmemo")]),t._v(" "),e("ul",[e("li",[t._v("Memo仅检查 props 变更")]),t._v(" "),e("li",[t._v("默认情况下其只会对复杂对象做浅层对比")]),t._v(" "),e("li",[t._v("仅作为**"),e("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/optimizing-performance.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("性能优化"),e("OutboundLink")],1),t._v("**的方式而存在。但请不要依赖它来“阻止”渲染")])]),t._v(" "),e("h2",{attrs:{id:"参考文章"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[t._v("#")]),t._v(" 参考文章")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://zhihu.com/question/450047614",target:"_blank",rel:"noopener noreferrer"}},[t._v("如何优雅地处理使用 React Context 导致的不必要渲染问题？"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/facebook/react/issues/15156",target:"_blank",rel:"noopener noreferrer"}},[t._v("Preventing rerenders with React.memo and useContext hook"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://juejin.cn/post/6889247428797530126",target:"_blank",rel:"noopener noreferrer"}},[t._v("我在工作中写React，学到了什么？性能优化篇"),e("OutboundLink")],1)])])}),[],!1,null,null,null);e.default=s.exports}}]);